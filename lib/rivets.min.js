// rivets.js
// version: 0.3.11
// author: Michael Richards
// license: MIT
(function(){var e,t,n,r,i,s,o,u,a,f=function(e,t){return function(){return e.apply(t,arguments)}},l=[].slice,c=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};e={},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),e.Binding=function(){function u(n,s,u,a,l){this.el=n,this.type=s,this.model=u,this.keypath=a,this.options=l!=null?l:{},this.unbind=f(this.unbind,this),this.bind=f(this.bind,this),this.publish=f(this.publish,this),this.sync=f(this.sync,this),this.set=f(this.set,this),this.formattedValue=f(this.formattedValue,this),this.isBidirectional=f(this.isBidirectional,this),this.routine=function(){switch(this.options.special){case"event":return i(this.type);case"class":return r(this.type);case"iteration":return o(this.type);default:return e.routines[this.type]||t(this.type)}}.call(this),this.formatters=this.options.formatters||[]}return u.prototype.isBidirectional=function(){var e;return(e=this.type)==="value"||e==="checked"||e==="unchecked"},u.prototype.formattedValue=function(t){var n,r,i,s,o,u,a,f;u=this.formatters;for(s=0,o=u.length;s<o;s++)r=u[s],n=r.split(/\s+/),i=n.shift(),t=this.model[i]instanceof Function?(a=this.model)[i].apply(a,[t].concat(l.call(n))):e.formatters[i]?(f=e.formatters)[i].apply(f,[t].concat(l.call(n))):void 0;return t},u.prototype.set=function(e){return e=e instanceof Function&&this.options.special!=="event"?this.formattedValue(e.call(this.model)):this.formattedValue(e),this.options.special==="event"?this.currentListener=this.routine(this.el,this.model,e,this.currentListener):this.options.special==="iteration"?this.routine(this.el,e,this):this.routine(this.el,e)},u.prototype.sync=function(){return this.set(this.options.bypass?this.model[this.keypath]:e.config.adapter.read(this.model,this.keypath))},u.prototype.publish=function(){return e.config.adapter.publish(this.model,this.keypath,s(this.el))},u.prototype.bind=function(){var t,r,i,s,o,u,a;this.options.bypass?this.sync():(e.config.adapter.subscribe(this.model,this.keypath,this.sync),e.config.preloadData&&this.sync());if((u=this.options.dependencies)!=null?u.length:void 0){a=this.options.dependencies;for(s=0,o=a.length;s<o;s++)t=a[s],/^\./.test(t)?(i=this.model,r=t.substr(1)):(t=t.split("."),i=this.view.models[t.shift()],r=t.join(".")),e.config.adapter.subscribe(i,r,this.sync)}if(this.isBidirectional()&&!this.options.bypass)return n(this.el,"change",this.publish)},u.prototype.unbind=function(){var t,n,r,i,s;if(!this.options.bypass){e.config.adapter.unsubscribe(this.model,this.keypath,this.sync);if((i=this.options.dependencies)!=null?i.length:void 0){s=this.options.dependencies;for(n=0,r=s.length;n<r;n++)t=s[n],e.config.adapter.unsubscribe(this.model,t,this.sync)}if(this.isBidirectional())return this.el.removeEventListener("change",this.publish)}},u}(),e.View=function(){function t(e,t){this.els=e,this.models=t,this.publish=f(this.publish,this),this.sync=f(this.sync,this),this.unbind=f(this.unbind,this),this.bind=f(this.bind,this),this.select=f(this.select,this),this.build=f(this.build,this),this.bindingRegExp=f(this.bindingRegExp,this),this.els.jquery||this.els instanceof Array||(this.els=[this.els]),this.build()}return t.prototype.bindingRegExp=function(){var t;return t=e.config.prefix,t?new RegExp("^data-"+t+"-"):/^data-/},t.prototype.build=function(){var t,n,r,i,s,o,u,a,f,l,h,p,d,v,m,g=this;this.bindings=[],f=[],o=null,t=this.bindingRegExp(),i=/^on-/,n=/^class-/,s=/^each-/,a=function(r){var u,a,l,h,p,d,v,m,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H;if(c.call(f,r)<0){D=r.attributes;for(N=0,A=D.length;N<A;N++){a=D[N];if(t.test(a.name)){T=a.name.replace(t,"");if(s.test(T)&&!g.models[T.replace(s,"")]){P=r.getElementsByTagName("*");for(C=0,O=P.length;C<O;C++)y=P[C],f.push(y);o=[a]}}}H=o||r.attributes;for(k=0,M=H.length;k<M;k++){a=H[k];if(t.test(a.name)){b={},T=a.name.replace(t,""),S=function(){var e,t,n,r;n=a.value.split("|"),r=[];for(e=0,t=n.length;e<t;e++)E=n[e],r.push(E.trim());return r}(),h=function(){var e,t,n,r;n=S.shift().split("<"),r=[];for(e=0,t=n.length;e<t;e++)p=n[e],r.push(p.trim());return r}(),w=h.shift(),x=w.split(/\.|:/),b.formatters=S,m=x[0]?g.models[x.shift()]:g.models,b.bypass=w.indexOf(":")!==-1,v=x.join(".");if(m){if(d=h.shift())b.dependencies=d.split(/\s+/);i.test(T)&&(T=T.replace(i,""),b.special="event"),n.test(T)&&(T=T.replace(n,""),b.special="class"),s.test(T)&&(T=T.replace(s,""),b.special="iteration"),l=new e.Binding(r,T,m,v,b),l.view=g,g.bindings.push(l)}}if(o){for(L=0,_=o.length;L<_;L++)u=o[L],r.removeAttribute(u.name);o=null}}}},v=this.els;for(l=0,p=v.length;l<p;l++){r=v[l],a(r),m=r.getElementsByTagName("*");for(h=0,d=m.length;h<d;h++)u=m[h],a(u)}},t.prototype.select=function(e){var t,n,r,i,s;i=this.bindings,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],e(t)&&s.push(t);return s},t.prototype.bind=function(){var e,t,n,r,i;r=this.bindings,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.bind());return i},t.prototype.unbind=function(){var e,t,n,r,i;r=this.bindings,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.unbind());return i},t.prototype.sync=function(){var e,t,n,r,i;r=this.bindings,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.sync());return i},t.prototype.publish=function(){var e,t,n,r,i;r=this.select(function(e){return e.isBidirectional()}),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.publish());return i},t}(),n=function(e,t,n,r){var i;return i=function(e){return n.call(r,e)},window.jQuery!=null?(e=jQuery(e),e.on!=null?e.on(t,i):e.bind(t,i)):window.addEventListener!=null?e.addEventListener(t,i,!1):(t="on"+t,e.attachEvent(t,i)),i},a=function(e,t,n){return window.jQuery!=null?(e=jQuery(e),e.off!=null?e.off(t,n):e.unbind(t,n)):window.removeEventListener?e.removeEventListener(t,n,!1):(t="on"+t,e.detachEvent(t,n))},s=function(e){var t,n,r,i;switch(e.type){case"checkbox":return e.checked;case"select-multiple":i=[];for(n=0,r=e.length;n<r;n++)t=e[n],t.selected&&i.push(t.value);return i;default:return e.value}},i=function(e){return function(t,r,i,s){return s&&a(t,e,s),n(t,e,i,r)}},r=function(e){return function(t,n){var r,i;r=" "+t.className+" ",i=r.indexOf(" "+e+" ")!==-1;if(!n===i)return t.className=n?""+t.className+" "+e:r.replace(" "+e+" "," ").trim()}},o=function(e){return function(t,n,r){var i,s,o,a,f,l,c,h,p,d,v,m,g,y,b;if(r.iterated!=null){m=r.iterated;for(h=0,d=m.length;h<d;h++)a=m[h],a.view.unbind(),a.el.parentNode.removeChild(a.el)}else r.marker=document.createComment(" rivets: each-"+e+" "),t.parentNode.insertBefore(r.marker,t),t.parentNode.removeChild(t);r.iterated=[],b=[];for(p=0,v=n.length;p<v;p++){s=n[p],i={},g=r.view.models;for(l in g)f=g[l],i[l]=f;i[e]=s,o=t.cloneNode(!0),c=r.iterated[r.iterated.length-1]||r.marker,r.marker.parentNode.insertBefore(o,(y=c.nextSibling)!=null?y:null),b.push(r.iterated.push({el:o,view:u.bind(o,i)}))}return b}},t=function(e){return function(t,n){return n?t.setAttribute(e,n):t.removeAttribute(e)}},e.routines={enabled:function(e,t){return e.disabled=!t},disabled:function(e,t){return e.disabled=!!t},checked:function(e,t){return e.type==="radio"?e.checked=e.value===t:e.checked=!!t},unchecked:function(e,t){return e.type==="radio"?e.checked=e.value!==t:e.checked=!t},show:function(e,t){return e.style.display=t?"":"none"},hide:function(e,t){return e.style.display=t?"none":""},html:function(e,t){return e.innerHTML=t!=null?t:""},value:function(e,t){var n,r,i,s,o;if(e.type!=="select-multiple")return e.value=t!=null?t:"";if(t!=null){o=[];for(r=0,i=e.length;r<i;r++)n=e[r],o.push(n.selected=(s=n.value,c.call(t,s)>=0));return o}},text:function(e,t){return e.innerText!=null?e.innerText=t!=null?t:"":e.textContent=t!=null?t:""}},e.config={preloadData:!0},e.formatters={},u={routines:e.routines,formatters:e.formatters,config:e.config,configure:function(t){var n,r;t==null&&(t={});for(n in t)r=t[n],e.config[n]=r},bind:function(t,n){var r;return n==null&&(n={}),r=new e.View(t,n),r.bind(),r}},typeof module!="undefined"&&module!==null?module.exports=u:this.rivets=u}).call(this);